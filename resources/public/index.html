<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Freefrog</title>
</head>
<body>
welcome to freefrog
<input type="button" onclick="navigator.id.request()" value="Login"
        id="login_btn" style="display:none"/>
<input type="button" onclick="navigator.id.logout()" value="Logout"
        id="logout_btn" style="display:none"/>

    <pre id="result">

    </pre>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://login.persona.org/include.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script type="application/javascript">
    function loggedIn(user) {
        $('#login_btn').hide('fast', function() {
            $('#logout_btn').show('fast', function() {
                $('#result').html("Welcome: " + user);
            });
        });
    }

    function loggedOut() {
        $('#login_btn').show();
        $('#result').empty();
    }

    function watch(user) {
        $('#result').html("Logging in...");
        navigator.id.watch({
            loggedInUser: user,
            onlogin: function (assertion) {
                console.log('Assertion: ', assertion);
                $.ajax({
                    type: 'POST',
                    url: '/api/session',
                    data: JSON.stringify({assertion: assertion}),
                    contentType: 'application/json',
                    success: function (res, status, xhr) {
                        loggedIn(res);
                    },
                    error: function (xhr, status, err) {
                        navigator.id.logout();
                        console.log('Login error: ', err);
                    }
                });
            },

            onlogout: function () {
                $.ajax({
                    type: 'DELETE',
                    url: '/api/session',
                    success: function (res, status, xhr) {
                        $('#logout_btn').hide('fast', loggedOut);
                    },
                    error: function (xhr, status, err) {
                        console.log('Logout error: ', err);
                    }
                });
            }
        });
    }

    $(document).ready(function () {
        $.ajax({
            url: '/api/session',
            type: 'GET',
            success: function(res, status, xhr) {
                watch(res);
                loggedIn(res);
            },
            error: function(xhr, status, err) {
                console.log('Session validation: ', err);
                if (err === 'Not Found') {
                    watch(null);
                    loggedOut();
                }
            }
        });
    });
</script>
</body>
</html>